# ---------- PREAMBLE ----------
units           metal
atom_style      charge
boundary        p p p
read_data       Li2MgMn3O8_crystal.data

pair_style      buck/coul/long 12.0
kspace_style    pppm 1.0e-4
pair_modify     mix arithmetic
pair_coeff      * * 1388.77 0.3623 0.0

neighbor        4.0 bin
neigh_modify    every 1 delay 0 check yes
thermo          2000
thermo_style    custom step temp press pe etotal

# ---------- HELPERS ----------
velocity        all create 300.0 12345 mom yes rot yes dist gaussian
fix             soft all nve/limit 0.03
fix             tl   all langevin 300.0 300.0 5.0 7777
timestep        0.001
run             1500
unfix           tl
unfix           soft

# sampling (order proxy + RDF + MSD)
compute         csm all centro/atom fcc
compute         cavg all reduce ave c_csm
compute         msdall all msd
compute         gr all rdf 200

# ---- Split ave/time ----
fix             obs all ave/time 200 1 200 c_cavg c_msdall[4] ave running file Li2MgMn3O8_obs.txt overwrite
fix             rdf all ave/time 200 1 200 c_gr[*]            ave running file Li2MgMn3O8_rdf.txt mode vector overwrite
# ------------------------

# A truly empty region to re-init groups every fraction
region          RNULL block 0 0 0 0 0 0 units box

# ---------- LOOP OVER HOT FRACTIONS ----------
variable        nF equal 5
variable        frac index 0.200 0.400 0.600 0.800 1.000

label           fracLoop

# --- (A) DEFINE HOT REGION AS RANDOM UNION OF SPHERES ---
variable        Rs       equal 20.0           # Ã…
variable        Ns       equal 10
variable        seed     equal 9999

# reset groups to empty via empty region
group           HOT  region RNULL
group           COLD region RNULL

# box dims
variable        Lx equal xhi-xlo
variable        Ly equal yhi-ylo
variable        Lz equal zhi-zlo

# build Ns spheres and union into HOT
variable        i loop ${Ns}
label           mk
  variable xr equal xlo + ${Lx}*random(0.0,1.0,${seed}+${i})
  variable yr equal ylo + ${Ly}*random(0.0,1.0,${seed}+2*${i})
  variable zr equal zlo + ${Lz}*random(0.0,1.0,${seed}+3*${i})
  region   sph_${i} sphere ${xr} ${yr} ${zr} ${Rs} units box
  if "${i} == 1" then "group HOT region sph_${i}"                   else "group HOT union HOT region sph_${i}"
next            i
jump            SELF mk

# COLD is the complement
group           COLD subtract all HOT

# report selection
variable        nAll equal count(all)
variable        nHot equal count(HOT)
print           "Selected HOT ~ ${nHot}/${nAll} atoms (target fraction = ${frac})"

# --- (B) SPLIT THERMOSTATS: HEAT ONLY HOT ---
variable        Thot  equal 4000.0
variable        Tcold equal 300.0

fix             fH HOT  nvt temp ${Tcold} ${Thot} 5.0
fix             fC COLD nvt temp ${Tcold} ${Tcold} 5.0
fix             dtr all dt/reset 200 0.0008 0.0012 0.02
dump            dH HOT  custom 200 Li2MgMn3O8_frac_${frac}_HOT.lammpstrj  id type x y z
dump            dC COLD custom 200 Li2MgMn3O8_frac_${frac}_COLD.lammpstrj id type x y z
dump_modify     dH sort id
dump_modify     dC sort id

run             20000
unfix           dtr
run             20000

# --- (C) QUENCH HOT -> 900 K FAST ---
# Try to retarget fH to 900 K. If your build lacks fix_modify support, the
# alternative is to unfix+re-fix at 900 K. We'll attempt fix_modify first:
variable _tryfm equal 1
if "$${_tryfm} > 0" then "fix_modify fH temp ${Thot} 900.0 5.0" else "print "skip""
run             50000

# merge groups and equilibrate the whole system
unfix           fH
unfix           fC
undump          dH
undump          dC

# --- (D) WHOLE-SYSTEM NPT COOL 900 -> 300 K ---
fix             cool all npt temp 900.0 300.0 10.0 iso 1.0 1.0 200.0
fix             dtr2 all dt/reset 200 0.0008 0.0012 0.02
dump            box all custom 1000 Li2MgMn3O8_frac_${frac}_BOX.lammpstrj id type x y z
dump_modify     box sort id
run             200000
unfix           dtr2
unfix           cool
undump          box

# --- (E) FINAL RELAX + SAVE ---
minimize        1.0e-4 1.0e-6 1000 10000
write_data      Li2MgMn3O8_out_frac_${frac}.data
write_dump      all xyz Li2MgMn3O8_out_frac_${frac}.xyz modify element Li Mn Mg O

next            frac
jump            SELF fracLoop
